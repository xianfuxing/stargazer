<script>
    var myChart = echarts.init(document.getElementById('cpu'));

    var history_data;
    var data;
    function getHistoryData(callback) {
        $.ajax({
            url: "{% url 'monitor:history' host.hostname 'cpu' 'idle' %}",
            type: 'get',
            dataType: 'json',
            async: true,
            success: function(_data) {
                if (_data.data) {
                    history_data = _data.data;
                    data = history_data;
                    callback(history_data)
                } else {
                    alert('Error: history is not found');
                }
            }
        });
        //return history_data
    }
    getHistoryData(function () {
        var option = {
            title: {
                text: 'CPU使用率'
            },
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    params = params[0];
                    var date = new Date(params.name);
                    return date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + '  ' + params.value[1];
                },
                axisPointer: {
                    animation: false
                }
            },
            xAxis: {
                type: 'time',
                splitLine: {
                    show: false
                }
            },
            yAxis: {
                type: 'value',
                boundaryGap: [0, '100%'],
                splitLine: {
                    show: false
                }
            },
            series: [{
                name: '模拟数据',
                type: 'line',
                showSymbol: false,
                hoverAnimation: false,
                smooth: true,
                data: history_data
            }]
        };
        myChart.setOption(option);

        setInterval(function () {
             $.get("{% url 'monitor:item' host.hostname 'cpu' 'idle' %}", function(responseTxt, statusTxt, xhr)
                 {
                    value = responseTxt.lastvalue;
                    date = new Date(parseInt(responseTxt.lastclock) * 1000);
                    console.log(date.getHours()+' '+ date.getMinutes());
                    console.log(statusTxt);
                    //if (statusTxt == "success")alert(test);
                    data.shift();
                    data.push({
                        name: date.toString(),
                        value: [
                            [date.getFullYear(), date.getMonth() + 1, date.getDate()].join('/') + ' ' +
                            date.getHours()+':'+((date.getMinutes()<10?'0':'') + date.getMinutes())+':'+date.getSeconds(),
                            (100 - value).toFixed(2)
                        ]
                    });
                    if (statusTxt == "error")
                        console("Error: " + xhr.status + ": " + xhr.statusText);
                 });

            //更新数据
            myChart.setOption({
                series: [{
                    data: data
                }]
            });
        }, 60000);
    })

</script>